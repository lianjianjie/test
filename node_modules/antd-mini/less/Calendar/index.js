import { __assign, __spreadArray } from "tslib";
import dayjs from 'dayjs';
import isoWeek from 'dayjs/plugin/isoWeek';
import { alipayComponent, useEffect, useEvent, useState, useComponent, } from 'functional-mini/component';
import { defaultLocaleText, } from './props';
import { defaultMonthRange, getMonthListFromRange, getSelectionModeFromValue, renderCells, } from './utils';
import { useMergedState } from '../_util/hooks/useMergedState';
dayjs.extend(isoWeek);
function getBoundingClientRect(instance, selector) {
    return new Promise(function (resolve, reject) {
        instance
            .createSelectorQuery()
            .select(selector)
            .boundingClientRect()
            .exec(function (ret) {
            if (ret && ret[0]) {
                resolve(ret[0]);
            }
            else {
                reject();
            }
        });
    });
}
var Calendar = function (props) {
    var _a, _b;
    var localeText = Object.assign({}, defaultLocaleText, props.localeText);
    var markItems = __spreadArray([], localeText.weekdayNames, true);
    var weekStartsOn = props.weekStartsOn;
    if (weekStartsOn === 'Sunday') {
        var item = markItems.pop();
        if (item)
            markItems.unshift(item);
    }
    var _c = useMergedState(props.defaultValue, {
        value: props.value,
    }), value = _c[0], setValue = _c[1];
    var selectionModeFromValue = getSelectionModeFromValue(value);
    var selectionMode = (_b = (_a = props.selectionMode) !== null && _a !== void 0 ? _a : selectionModeFromValue) !== null && _b !== void 0 ? _b : 'range';
    function updateValue(newValue) {
        var isControl = typeof props.value !== 'undefined';
        if (props.onChange) {
            props.onChange(newValue);
        }
        if (!isControl) {
            setValue(newValue);
        }
    }
    useEvent('clickCell', function (e) {
        var clickDate = dayjs(e.target.dataset.time.time);
        if (e.target.dataset.time.disabled) {
            return;
        }
        if (selectionMode === 'range') {
            if (Array.isArray(value)) {
                if (value.length === 1) {
                    var current = value[0];
                    if (dayjs(clickDate.toDate().getTime()).isBefore(dayjs(current))) {
                        updateValue([clickDate.toDate().getTime()]);
                    }
                    else {
                        updateValue([value[0], clickDate.toDate().getTime()]);
                    }
                }
                else {
                    updateValue([clickDate.toDate().getTime()]);
                }
            }
            else {
                updateValue([clickDate.toDate().getTime()]);
            }
        }
        else if (selectionMode === 'single') {
            updateValue(clickDate.toDate().getTime());
        }
    }, [selectionMode, value]);
    var monthList = getMonthListFromRange(dayjs(props.monthRange[0]), dayjs(props.monthRange[1])).map(function (p) {
        var cells = renderCells(p, weekStartsOn, value, localeText);
        if (props.onFormatter && typeof props.onFormatter === 'function') {
            cells = cells.map(function (o) {
                var _a;
                var time = o.time, top = o.top, bottom = o.bottom, disabled = o.disabled, isSelectedBegin = o.isSelectedBegin, isSelectedEnd = o.isSelectedEnd, isSelected = o.isSelected;
                var newState = (_a = props.onFormatter({
                    time: time,
                    top: top ? __assign({}, top) : undefined,
                    bottom: bottom ? __assign({}, bottom) : undefined,
                    disabled: disabled,
                    isSelectedBegin: isSelectedBegin,
                    isSelectedEnd: isSelectedEnd,
                    isSelected: isSelected,
                }, value)) !== null && _a !== void 0 ? _a : {};
                var result = __assign({}, o);
                if (typeof newState === 'object') {
                    // 只允许修改三个字段
                    ['top', 'bottom', 'disabled'].forEach(function (key) {
                        if (key in newState) {
                            result[key] = newState[key];
                        }
                    });
                }
                return result;
            });
        }
        return {
            title: p.format(localeText.title),
            cells: cells,
        };
    });
    var _d = useState(0), headerState = _d[0], setHeaderState = _d[1];
    useEvent('setCurrentMonth', function (e) {
        setHeaderState(e);
    }, []);
    var _e = useState(null), elementSize = _e[0], setElementSize = _e[1];
    var componentInstance = useComponent();
    useEffect(function () {
        Promise.all([
            getBoundingClientRect(componentInstance, '.ant-calendar-cells'),
            getBoundingClientRect(componentInstance, '.ant-calendar-title-container'),
        ])
            .then(function (_a) {
            var cellContainer = _a[0], Title = _a[1];
            var monthTitleHeight = Title.height + cellContainer.top - Title.bottom;
            var cellHight = cellContainer.height / (monthList[0].cells.length / 7);
            var paddingHeight = cellContainer.top - Title.bottom;
            setElementSize({
                monthTitleHeight: monthTitleHeight,
                cellHight: cellHight,
                paddingHeight: paddingHeight,
            });
        })
            .catch(function () {
            setElementSize(null);
        });
    }, []);
    return {
        elementSize: elementSize,
        markItems: markItems,
        monthList: monthList,
        headerState: headerState,
    };
};
Component(alipayComponent(Calendar, {
    monthRange: defaultMonthRange(),
    weekStartsOn: 'Sunday',
    localeText: defaultLocaleText,
}));
